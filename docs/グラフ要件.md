# グラフ機能 要件定義

## 概要
グラフタブでは、証拠・秘密・場所・人物のノードとそれらの関係（エッジ）を視覚的に管理し、ロジック（連結成分）ごとに整理する。

## 機能要件

### 1. ノード追加
- **2段階UI**: 
  1. まずノードの種類（証拠 / 秘密 / 場所 / 人物）を選択
  2. 次に、その種類の既存要素から選択するか、「新規作成」を選択
- **ハンドルドラッグ**: ノードのハンドル（接続点）をキャンバスにドラッグしてドロップすると、種類選択モーダルが開き、新規ノードを追加・接続できる

### 2. ノード表示
- **タイトル表示**: ノードはIDではなく、意味が分かるタイトルで表示する
  - 証拠: `evidence.name`
  - 秘密: `secret.title || secret.description || "(無題)"`
  - 場所: `location.name`
  - 人物: `character.name`

### 3. レイアウト・整列
- **ロジックごとの階層整列**: ノードはロジック（連結成分）ごとに縦に並べる
- **分岐処理**: 分岐するところ（複数の出エッジを持つノード）は一番左の列に縦に並べる
- **同階層の横並び**: 同じ階層のノードは重ならないように横に並べる
- **整列ボタン**: 「整列」ボタンを押したときのみレイアウトを適用する。ノード追加時は自動整列しない

### 4. イベントグループ
- **親子関係**: イベントに属するノードは、親イベントノード内に子ノードとして表示される
- **一体化移動**: 親イベントノードをドラッグすると、その中の子ノードも一緒に移動する
- **子ノードの固定**: イベントグループ内の子ノードは個別にドラッグできない（`draggable: false`）
- **複数ノードのグループ化**: 複数のノードが同じイベントに紐づく場合、それらすべてが同じ親イベントノード内に子ノードとして配置される
- **イベント追加機能**: 既存のノードに後から `event_id` を設定できる。設定・変更時は、ノードをイベントグループ内に移動させる（構造変更として扱い、レイアウトを更新）

### 5. ノード編集
- **クリックで編集**: ノードをクリックすると、そのノードの種類に応じた編集モーダルが開く
  - 証拠ノード → `EditEvidenceModal`
  - 秘密ノード → `EditSecretModal`
  - 場所ノード → `EditLocationModal`
  - 人物ノード → `EditCharacterModal`
- **イベントグループ親ノード**: イベントグループの親ノード（枠）をクリックしても編集モーダルは開かない

### 6. エッジ（接続）
- **ラベル非表示**: エッジの中間に「supports」などのラベルは表示しない
- **色分け**: エッジはロジックごとに色分けされる（同じロジック内のエッジは同じ色）

### 7. ロジック詳細
- **右クリック**: ノードを右クリックすると、そのノードが属するロジックの詳細が表示される

## 技術要件

### データ構造
- **GraphNode**: `node_id`, `node_type`, `reference_id`, `event_id`, `logic_details`, `logic_related_entities`
- **GraphEdge**: `edge_id`, `source_node_id`, `target_node_id`, `edge_type`
- **Logic**: `logic_id`, `name`, `color`

### React Flow ノード構造
- **通常ノード**: `id` = `node.node_id`, `data.node` = `GraphNode`
- **イベントグループ親ノード**: `id` = `event_group_${eventId}`, `data.node` = `null`, `data.isEventGroup` = `true`
- **イベントグループ子ノード**: `id` = `node.node_id`, `parentId` = `event_group_${eventId}`, `extent` = `"parent"`, `draggable` = `false`

### レイアウト管理
- **layoutRevision**: レイアウト適用のバージョン管理
- **初期レイアウト**: グラフデータが初めて読み込まれたときに1回だけ適用
- **整列ボタン**: `layoutRevision` をインクリメントしてレイアウトを再適用
- **ノード追加時**: 既存ノードの位置を保持しつつ、新規ノードのみ追加（マージ）
- **イベントグループ変更時**: `eventGroups` の変更を検知して、`layoutRevision` をインクリメントしてレイアウトを再適用

## 実装上の注意点
- イベントグループへの移動は「構造変更」として扱い、明示的にレイアウトを更新する（整列ボタンとは別の処理）
- イベントグループの子ノードは固定位置（グリッド配置）に配置され、ユーザーが動かした位置は失われる（仕様として受け入れる）
- 編集モーダルで `event_id` を設定・変更した後、`refreshGraph` が呼ばれると、`eventGroups` が再計算され、変更が検知されてレイアウトが更新される
